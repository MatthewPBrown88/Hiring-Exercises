--MatthewPBrown88 Answer Script
--SQL Server Syntax


--Check to see if table is already created. If not, create dbo.EXAMPLE_CLIENTS. If it is, then truncate the table.

DECLARE @SQL VARCHAR(MAX)
IF (SELECT OBJECT_ID('EXAMPLE_CLIENTS', 'U')) IS NULL

    BEGIN;
    
           SET @SQL= 'CREATE TABLE [dbo].[EXAMPLE_CLIENTS]
            (
            	[id] [bigint] NOT NULL,
            	[created_at] [varchar](255) NOT NULL,
            	[status] [varchar](255) NOT NULL,
            	[status_history] [varchar](max) NOT NULL,
            	[Counter] INT NULL
            )'
    
    END

IF (SELECT OBJECT_ID('EXAMPLE_CLIENTS', 'U')) IS NOT NULL

    BEGIN;
    
           SET @SQL= 'DELETE FROM dbo.EXAMPLE_CLIENTS'
    
    END

EXEC sp_sqlexec @SQL


--Populate Example_clients

INSERT INTO example_clients (id, created_at, status, status_history)
  VALUES
    (74436, '2021-07-11 11:25:41.441051', 'prelead', '{"prelead":"2021-07-11T07:25:41.439-04:00"}'),
    (71738, '2021-07-01 17:02:12.318914', 'prospect', '{"prospect":"2021-07-01T13:11:13.642-04:00"}'),
    (74287, '2021-07-10 13:27:13.423218', 'active', '{"active":"2021-07-10T10:11:20.324-04:00", "prelead":"2021-07-10T09:27:13.421-04:00", "prospect":"2021-07-10T10:10:16.244-04:00"}'),
    (72820, '2021-07-06 15:30:43.528012', 'active', '{"active":"2021-07-06T12:43:54.526-04:00", "prelead":"2021-07-06T11:30:43.526-04:00", "prospect":"2021-07-06T12:34:22.719-04:00"}'),
    (73141, '2021-07-07 14:11:43.264736', 'active', '{"active":"2021-07-07T10:33:00.804-04:00", "prelead":"2021-07-07T10:11:43.262-04:00", "prospect":"2021-07-07T10:24:39.474-04:00"}'),
    (72241, '2021-07-02 22:24:35.60107', 'prospect', '{"prelead":"2021-07-02T18:24:35.599-04:00", "prospect":"2021-07-02T18:48:59.759-04:00"}'),
    (74441, '2021-07-11 12:25:43.609261', 'prelead', '{"prelead":"2021-07-11T08:25:43.608-04:00"}'),
    (72359, '2021-07-03 17:43:38.672264', 'lead', '{}'),
    (74282, '2021-07-10 13:12:46.635733', 'active', '{"active":"2021-07-11T12:46:03.138-04:00", "prelead":"2021-07-10T09:12:46.634-04:00", "prospect":"2021-07-11T12:44:53.814-04:00"}'),
    (72573, '2021-07-05 15:51:53.494864', 'prospect', '{"active":"2021-07-05T12:06:47.346-04:00", "prelead":"2021-07-05T11:51:53.493-04:00", "prospect":"2021-07-12T09:43:58.124-04:00", "suspended":"2021-07-12T09:43:55.529-04:00"}'),
    (73369, '2021-07-07 21:05:56.621201', 'prospect', '{"prelead":"2021-07-07T17:05:56.619-04:00", "prospect":"2021-07-07T17:48:25.446-04:00"}'),
    (71830, '2021-07-01 20:26:19.981101', 'suspended', '{"prelead":"2021-07-01T16:26:19.979-04:00"}'),
    (74475, '2021-07-11 17:45:08.343476', 'active', '{"active":"2021-07-11T13:51:06.265-04:00", "prospect":"2021-07-11T13:45:11.685-04:00"}'),
    (74457, '2021-07-11 15:36:11.943176', 'active', '{"active":"2021-07-11T12:06:19.466-04:00", "prelead":"2021-07-11T11:36:11.942-04:00", "prospect":"2021-07-11T12:00:53.365-04:00"}'),
    (73500, '2021-07-08 13:17:40.591046', 'active', '{"active":"2021-07-08T09:59:28.808-04:00", "prelead":"2021-07-08T09:17:40.589-04:00", "prospect":"2021-07-08T09:49:57.903-04:00"}'),
    (72758, '2021-07-06 10:30:49.155229', 'active', '{"active":"2021-07-06T06:51:47.485-04:00", "prelead":"2021-07-06T06:30:49.154-04:00", "prospect":"2021-07-06T06:41:35.044-04:00"}'),
    (74517, '2021-07-11 22:10:50.915227', 'lead', '{}'),
    (73129, '2021-07-07 13:37:46.299571', 'suspended', '{"prelead":"2021-07-07T09:37:46.297-04:00"}'),
    (73807, '2021-07-08 22:32:12.631203', 'active', '{"active":"2021-07-08T18:42:59.347-04:00", "prospect":"2021-07-08T18:32:16.044-04:00"}'),
    (73394, '2021-07-07 21:29:14.950186', 'prospect', '{"active":"2021-07-07T17:43:20.406-04:00", "prelead":"2021-07-07T17:29:14.948-04:00", "prospect":"2021-07-12T09:46:37.331-04:00", "suspended":"2021-07-12T09:46:34.824-04:00"}'),
    (73029, '2021-07-06 22:37:27.026926', 'suspended', '{"prelead":"2021-07-06T18:37:27.025-04:00"}'),
    (71820, '2021-07-01 20:08:15.570334', 'suspended', '{"prelead":"2021-07-01T16:08:15.568-04:00"}'),
    (73094, '2021-07-07 06:25:43.358118', 'lead', '{}'),
    (74501, '2021-07-11 20:19:35.108486', 'lead', '{}'),
    (73063, '2021-07-07 00:18:55.193604', 'lead', '{}'),
    (71824, '2021-07-01 20:13:53.178852', 'suspended', '{"prelead":"2021-07-01T16:13:53.177-04:00"}'),
    (74439, '2021-07-11 12:01:39.831695', 'prelead', '{"prelead":"2021-07-11T08:01:39.830-04:00"}'),
    (71825, '2021-07-01 20:16:42.650557', 'suspended', '{"prelead":"2021-07-01T16:16:42.649-04:00"}'),
    (71751, '2021-07-01 17:34:21.826324', 'lead', '{"prelead":"2021-07-01T13:34:21.825-04:00"}'),
    (74515, '2021-07-11 22:08:35.163435', 'lead', '{}'),
    (71835, '2021-07-01 20:33:50.208824', 'active', '{"active":"2021-07-01T16:39:57.680-04:00", "prospect":"2021-07-01T16:33:54.122-04:00"}'),
    (72740, '2021-07-06 02:44:34.050262', 'lead', '{}'),
    (73092, '2021-07-07 05:56:13.191341', 'active', '{"active":"2021-07-07T03:25:08.258-04:00", "prelead":"2021-07-07T01:56:13.189-04:00", "prospect":"2021-07-07T02:43:43.166-04:00"}'),
    (71826, '2021-07-01 20:19:09.378084', 'active', '{"active":"2021-07-01T16:43:42.797-04:00", "prospect":"2021-07-01T16:19:31.401-04:00"}'),
    (74442, '2021-07-11 12:32:52.720728', 'prelead', '{"prelead":"2021-07-11T08:32:52.718-04:00"}'),
    (73040, '2021-07-06 23:00:58.02181', 'prelead', '{"prelead":"2021-07-06T19:00:58.019-04:00"}'),
    (71829, '2021-07-01 20:25:50.957168', 'suspended', '{"prelead":"2021-07-01T16:25:50.956-04:00"}'),
    (73079, '2021-07-07 01:57:22.485791', 'suspended', '{"prelead":"2021-07-06T21:57:22.483-04:00"}'),
    (71642, '2021-07-01 04:37:58.804305', 'lead', '{}'),
    (74466, '2021-07-11 16:45:10.295123', 'lead', '{"prelead":"2021-07-11T12:45:10.293-04:00"}'),
    (71747, '2021-07-01 17:26:08.161341', 'lead', '{}'),
    (73036, '2021-07-06 22:55:45.845427', 'prelead', '{"prelead":"2021-07-06T18:55:45.844-04:00"}'),
    (71708, '2021-07-01 15:41:28.909318', 'prelead', '{"prelead":"2021-07-01T11:41:28.907-04:00"}'),
    (71777, '2021-07-01 18:27:03.942485', 'lead', '{"prelead":"2021-07-01T14:27:03.941-04:00"}'),
    (71641, '2021-07-01 04:29:32.064096', 'lead', '{}'),
    (71823, '2021-07-01 20:12:12.872855', 'suspended', '{"prelead":"2021-07-01T16:12:12.871-04:00"}'),
    (73026, '2021-07-06 22:33:41.672816', 'prelead', '{"prelead":"2021-07-06T18:33:41.671-04:00"}'),
    (71737, '2021-07-01 16:58:33.502087', 'prospect', '{"prelead":"2021-07-01T12:58:33.501-04:00", "prospect":"2021-07-02T17:18:47.880-04:00"}'),
    (73114, '2021-07-07 12:53:50.775053', 'suspended', '{"prelead":"2021-07-07T08:53:50.773-04:00"}'),
    (74512, '2021-07-11 21:49:29.254375', 'lead', '{}'),
    (71654, '2021-07-01 10:47:03.135379', 'lead', '{}'),
    (74443, '2021-07-11 12:45:36.585809', 'prelead', '{"prelead":"2021-07-11T08:45:36.584-04:00"}'),
    (73065, '2021-07-07 00:32:14.946195', 'suspended', '{"prelead":"2021-07-06T20:32:14.944-04:00"}'),
    (72040, '2021-07-02 16:06:33.729071', 'prospect', '{"prelead":"2021-07-02T12:06:33.727-04:00", "prospect":"2021-07-02T12:29:17.682-04:00"}'),
    (73229, '2021-07-07 17:20:52.712606', 'prospect', '{"prospect":"2021-07-07T13:23:46.719-04:00"}'),
    (71705, '2021-07-01 15:26:48.542759', 'prelead', '{"prelead":"2021-07-01T11:26:48.541-04:00"}'),
    (73041, '2021-07-06 23:08:37.943989', 'suspended', '{"prelead":"2021-07-06T19:08:37.942-04:00"}'),
    (74438, '2021-07-11 11:47:13.261931', 'prelead', '{"prelead":"2021-07-11T07:47:13.260-04:00"}'),
    (73194, '2021-07-07 16:08:48.228203', 'prospect', '{"prelead":"2021-07-07T12:08:48.226-04:00", "prospect":"2021-07-07T12:18:58.643-04:00"}'),
    (73118, '2021-07-07 13:02:37.924207', 'suspended', '{"prelead":"2021-07-07T09:02:37.920-04:00", "suspended":"2021-07-07T09:23:24.149-04:00"}'),
    (73030, '2021-07-06 22:40:28.692138', 'prelead', '{"prelead":"2021-07-06T18:40:28.690-04:00"}'),
    (72811, '2021-07-06 15:22:06.394413', 'prospect', '{"prelead":"2021-07-06T11:22:06.392-04:00", "prospect":"2021-07-06T11:36:52.521-04:00"}'),
    (73131, '2021-07-07 13:44:23.911939', 'suspended', '{"prelead":"2021-07-07T09:44:23.909-04:00"}'),
    (71805, '2021-07-01 19:29:51.820388', 'suspended', '{"prelead":"2021-07-01T15:29:51.818-04:00"}'),
    (73516, '2021-07-08 14:04:55.372276', 'active', '{"active":"2021-07-08T10:27:36.894-04:00", "prelead":"2021-07-08T10:04:55.370-04:00", "prospect":"2021-07-08T10:22:22.431-04:00"}'),
    (71727, '2021-07-01 16:15:53.00638', 'lead', '{}'),
    (73057, '2021-07-06 23:44:12.742238', 'lead', '{}'),
    (71901, '2021-07-01 23:22:07.453873', 'prospect', '{"prelead":"2021-07-01T19:22:07.452-04:00", "prospect":"2021-07-06T19:12:30.961-04:00"}'),
    (73038, '2021-07-06 22:56:09.780476', 'prelead', '{"prelead":"2021-07-06T18:56:09.778-04:00"}'),
    (74805, '2021-07-12 20:13:22.09922', 'prospect', '{"prospect":"2021-07-12T16:13:26.345-04:00"}'),
    (73035, '2021-07-06 22:55:39.989243', 'prelead', '{"prelead":"2021-07-06T18:55:39.988-04:00"}'),
    (74476, '2021-07-11 17:49:43.321339', 'lead', '{}'),
    (71821, '2021-07-01 20:10:39.028666', 'suspended', '{"prelead":"2021-07-01T16:10:39.026-04:00"}'),
    (73119, '2021-07-07 13:05:44.081794', 'prospect', '{"prelead":"2021-07-07T09:05:44.080-04:00", "prospect":"2021-07-07T09:13:48.511-04:00"}'),
    (74221, '2021-07-10 00:13:51.217668', 'prospect', '{"prelead":"2021-07-09T20:13:51.216-04:00", "prospect":"2021-07-09T21:36:00.823-04:00"}'),
    (73034, '2021-07-06 22:54:45.386313', 'prelead', '{"prelead":"2021-07-06T18:54:45.384-04:00"}'),
    (73047, '2021-07-06 23:16:09.612665', 'prelead', '{"prelead":"2021-07-06T19:16:09.610-04:00"}'),
    (74594, '2021-07-12 14:13:10.612606', 'active', '{"active":"2021-07-12T10:44:34.974-04:00", "prelead":"2021-07-12T10:13:10.610-04:00", "prospect":"2021-07-12T10:29:02.597-04:00"}'),
    (72870, '2021-07-06 16:49:07.536772', 'suspended', '{"prelead":"2021-07-06T12:49:07.535-04:00"}'),
    (74437, '2021-07-11 11:40:12.390861', 'prelead', '{"prelead":"2021-07-11T07:40:12.389-04:00"}'),
    (71780, '2021-07-01 18:31:22.595086', 'lead', '{}'),
    (74513, '2021-07-11 21:52:57.894399', 'suspended', '{"prelead":"2021-07-11T17:52:57.892-04:00"}'),
    (74446, '2021-07-11 13:15:47.652836', 'prelead', '{"prelead":"2021-07-11T09:15:47.651-04:00"}'),
    (73102, '2021-07-07 11:03:22.98498', 'active', '{"active":"2021-07-07T07:06:14.095-04:00", "prospect":"2021-07-07T07:03:26.366-04:00"}'),
    (71712, '2021-07-01 15:49:12.019183', 'active', '{"active":"2021-07-01T12:31:28.375-04:00", "prelead":"2021-07-01T11:49:12.016-04:00", "prospect":"2021-07-01T12:23:22.310-04:00"}'),
    (73096, '2021-07-07 07:00:41.432356', 'prospect', '{"prospect":"2021-07-07T05:08:30.631-04:00"}'),
    (72967, '2021-07-06 20:23:13.457006', 'prospect', '{"prelead":"2021-07-06T16:23:13.455-04:00", "prospect":"2021-07-07T12:53:24.346-04:00"}'),
    (73889, '2021-07-09 11:27:59.112408', 'active', '{"active":"2021-07-09T08:00:01.917-04:00", "prelead":"2021-07-09T07:27:59.111-04:00", "prospect":"2021-07-09T07:52:01.555-04:00"}'),
    (71728, '2021-07-01 16:21:55.634744', 'prospect', '{"prelead":"2021-07-01T12:21:55.633-04:00", "prospect":"2021-07-01T12:35:41.091-04:00"}'),
    (74467, '2021-07-11 16:49:41.952498', 'active', '{"active":"2021-07-11T13:24:14.851-04:00", "prelead":"2021-07-11T12:49:41.950-04:00", "prospect":"2021-07-11T13:22:55.709-04:00"}'),
    (71828, '2021-07-01 20:22:15.684263', 'suspended', '{"prelead":"2021-07-01T16:22:15.681-04:00"}'),
    (71718, '2021-07-01 15:59:28.232286', 'prelead', '{"prelead":"2021-07-01T11:59:28.231-04:00"}'),
    (71987, '2021-07-02 13:51:18.73685', 'prospect', '{"prospect":"2021-07-02T09:56:55.957-04:00"}'),
    (72980, '2021-07-06 20:54:44.798124', 'prospect', '{"prelead":"2021-07-06T16:54:44.795-04:00", "prospect":"2021-07-06T17:29:02.595-04:00"}'),
    (73128, '2021-07-07 13:37:22.658803', 'suspended', '{"prelead":"2021-07-07T09:37:22.657-04:00"}'),
    (73109, '2021-07-07 12:19:12.526325', 'active', '{"active":"2021-07-07T08:44:13.117-04:00", "prelead":"2021-07-07T08:19:12.525-04:00", "prospect":"2021-07-07T08:41:14.100-04:00"}'),
    (73049, '2021-07-06 23:21:24.602163', 'lead', '{}'),
    (73023, '2021-07-06 22:16:00.30397', 'prelead', '{"prelead":"2021-07-06T18:16:00.302-04:00"}'),
    (74450, '2021-07-11 13:49:09.850983', 'prospect', '{"prelead":"2021-07-11T09:49:09.848-04:00", "prospect":"2021-07-11T10:38:07.934-04:00"}'),
    (71831, '2021-07-01 20:30:06.079837', 'active', '{"active":"2021-07-01T16:43:17.637-04:00", "prospect":"2021-07-01T16:41:01.942-04:00"}')


--Remove brackets in anticipation of concatinatng all status histories together. Update field 'Counter' to be used in while loop.

UPDATE EXAMPLE_CLIENTS
SET status_history=SUBSTRING(EXAMPLE_CLIENTS.status_history,2,LEN(EXAMPLE_CLIENTS.status_history)-2),
    [Counter]=A.[Row_COUNT]
	FROM
	(
	  SELECT *
	  FROM
	      (
	        SELECT *, ROW_NUMBER() OVER(PARTITION BY GETDATE() ORDER BY GETDATE()) AS Row_Count
            FROM EXAMPLE_CLIENTS 
	      )B
	
   ) A
   WHERE EXAMPLE_CLIENTS.status_history!='' AND A.ID=EXAMPLE_CLIENTS.ID


--Decalare variables and create while loop to concatenate all status histories

DECLARE @COUNTER int
DECLARE @JSON_Concat NVARCHAR(MAX)

--Prepare first string by adding left bracket

SET @COUNTER=1
SET @JSON_Concat='{'+(SELECT STATUS_HISTORY FROM EXAMPLE_CLIENTS WHERE [COUNTER]=@COUNTER)

WHILE @COUNTER<=(SELECT MAX([COUNTER]) FROM EXAMPLE_CLIENTS)

      BEGIN;
      
            IF @COUNTER>=2
               BEGIN;
      	       
               --Prepare other strings by accounting for ID's without histories, and adding the right bracket to the final ID proccessed (i.e. the final statUs history concatenated)
      	       
               SET @JSON_Concat=@JSON_Concat+(CASE WHEN (SELECT STATUS_HISTORY FROM EXAMPLE_CLIENTS WHERE [COUNTER]=@COUNTER)='' THEN '' ELSE ',' END)+(SELECT STATUS_HISTORY FROM EXAMPLE_CLIENTS WHERE [COUNTER]=@COUNTER)+(CASE WHEN @COUNTER=(SELECT MAX([COUNTER]) FROM EXAMPLE_CLIENTS) THEN '}' ELSE '' END)
      	       
               END
      
      SET @COUNTER=@COUNTER+1
      
      END

--Set up SQL Server JSON parsing functionality

DECLARE @json_Parse NVARCHAR(MAX);
SET @json_Parse =
N''+@JSON_Concat+'';


--Insert status history back into table Example_Clients
INSERT INTO EXAMPLE_CLIENTS
SELECT 
999999 AS ID, 
[VALUE] AS Created_Date, 
[KEY] AS [Status], 
'N/A' AS Status_History, 
NULL AS [Counter]
FROM OPENJSON(@json_Parse)


--Create Pivot Table
SELECT
     Day,
     prelead as Preleads,
     lead as Leads,
     Prospect as Prospects,
     Active,
     Suspended

FROM
(

     SELECT 
          CAST(SUBSTRING(CREATED_AT,1,10) AS DATE) as Day, 
          STATUS, 
          ID
     FROM
          EXAMPLE_CLIENTS

) T

PIVOT(
    COUNT(ID) 
    FOR STATUS IN (
        [prelead], 
        [prospect], 
        [active], 
        [suspended], 
        [lead]
		          )
) AS pivot_table;
